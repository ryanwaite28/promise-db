<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>PromiseDB - IndexedDB Library</title>

    <link rel="stylesheet" type="text/css" href="https://ryanwaite28.github.io/my-cdn/css/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="https://ryanwaite28.github.io/my-cdn/css/emerald.css" />
    <link rel="icon" href="../database-logo.png"/>

    <style>
      a.delete-btn {
        color: red;
        margin: 10px 0px 0px 0px;
        display: inline-block;
        font-weight: 700;
      }
      ul#users-list {
        display: block;
        margin: auto;
        padding: 15px;
        width: 825px;
        max-width: 100%;
      }
      ul#users-list li {
        list-style: none;
        padding: 15px;
        background: #f2f2f2;
        border: 1px solid grey;
        margin-bottom: 15px;
        word-wrap: break-word;
        box-shadow: 0 1px 3px lightgrey;

        -webkit-transition: transition 0.3s;
        -moz-transition: transition 0.3s;
        -o-transition: transition 0.3s;
        -ms-transition: transition 0.3s;
        transition: 0.3s;
      }
      ul#users-list li:hover {
        background: #fbfbfb;
      }
    </style>

    <script src="https://ryanwaite28.github.io/my-cdn/js/jquery.js"></script>
    <script src="../idb-promise.min.js"></script>
  </head>
  <body>

    <h1 class="text-center">PromiseDB - IndexedDB Library</h1>
    <hr/>

    <input id="new-name-input" class="input-s1 middlr" type="text" placeholder="Enter a name"/>
    <br/>
    <p class="text-center"><a id="add-btn" class="btn btn-success">Create</a></p>

    <br/>

    <ul id="users-list"></ul>


    <!--  -->

    <script>
      $(document).ready(function(){

        let ul = $('#users-list');

        var users_db = IDB('users_db', 1, function(event){
          console.log(event);
          if(event) {
            var db = event.target.result;
            var objectStore = db.createObjectStore('users', {keyPath: 'uniqueValue'});
            objectStore.createIndex("name", "name", { unique: false });
          }

          setTimeout(init, 2000);
        });

        function create_user(data) {
          return new Promise(function(resolve, reject){
            users_db.then(function(db){
              db.stores('users').create(data)
              .then(function(obj){
                console.log('added!');
                return resolve(obj);
              })
              .catch(function(e){
                console.log('error', e);
                return reject(e);
              });
            });
          });
        }

        function get_user(key) {
          return new Promise(function(resolve, reject){
            users_db.then(function(db){
              db.stores('users').read(key)
              .then(function(data){
                console.log('read!');
                return resolve(data);
              })
              .catch(function(e){
                console.log('error', e);
                return reject(e);
              });
            });
          });
        }

        function get_all_users() {
          return new Promise(function(resolve, reject){
            users_db.then(function(db){
              db.stores('users').get_all()
              .then(function(data){
                console.log('read all!');
                return resolve(data);
              })
              .catch(function(e){
                console.log('error', e);
                return reject(e);
              });
            });
          });
        }

        function update_user(key, data) {
          return new Promise(function(resolve, reject){
            users_db.then(function(db){
              db.stores('users').update(key, data)
              .then(function(){
                console.log('updated!');
                return resolve();
              })
              .catch(function(e){
                console.log('error', e);
                return reject(e);
              });
            });
          });
        }

        function delete_user(key) {
          return new Promise(function(resolve, reject){
            users_db.then(function(db){
              db.stores('users').destroy(key)
              .then(function(){
                console.log('deleted!');
                return resolve();
              })
              .catch(function(e){
                console.log('error', e);
                return reject(e);
              });
            });
          });
        }

        function create_li(data) {
          let li_str = '<li class="item" id="' + data.uniqueValue + '">' +
            '<p>' +
            '<strong>Name</strong>: ' + data.name + '<br/>' +
            '<strong>uniqueValue</strong>: ' + data.uniqueValue + '<br/>' +
            '<a class="delete-btn" href="#" data-key="' + data.uniqueValue + '">delete</a>' +
            '</p>' +
          '</li>';
          let li = $(li_str);
          return li;
        }

        function render_data_li(data) {
          let li = create_li(data);
          ul.append(li);
        }

        function update_data_li(data) {
          let li = create_li(data);
          ul.find('#' + data.uniqueValue).replaceWith(li);
        }

        function delete_data_li(key) {
          ul.find('#' + key).remove();
        }

        $('#add-btn').click(function(){
          let value = $('#new-name-input').val().trim();
          if(!value) { return; }
          create_user({ name: value }).then(function(data){
            console.log(data);
            render_data_li(data);
            $('#new-name-input').val('');
          })
        });

        $(document).on('click', 'a.delete-btn', function(){
          let key = $(this).data('key');
          delete_user(key).then(function(){
            delete_data_li(key);
          });
        });

        // initial page load

        function init() {
          get_all_users().then(function(list){
            list.forEach(function(data){
              render_data_li(data);
            });
          });
        }

      });
    </script>
  </body>
</html>
